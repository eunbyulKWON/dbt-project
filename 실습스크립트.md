# âœ… 1ë‹¨ê³„ : ë¡œì»¬ ê°œë°œ í™˜ê²½ ì¤€ë¹„
ğŸ§© ì‚¬ì „ ì„¤ì¹˜
1. Docker Desktop ì„¤ì¹˜
2. VSCode ì„¤ì¹˜ 
3. VSCode í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ 
- Dev Containers (ms-vscode-remote.remote-containers)
- Docker (ms-azuretools.vscode-docker)

# ğŸ“‚ 2ë‹¨ê³„: í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
dbt_project/
|__ Dockerfile
|__ docker-compose.yml
|__ gcp-key.json
|__ .dbt/
    |__ profiles.yml
|__ my_dbt_project/
    |__ dbt_project.yml     â† init í›„ ìƒì„±ë¨
    |__ models/sample/
    |   |__ sample_model.sql
    |    |__ schema.yml

mkdir dbt_project & cd dbt_project

# ğŸ³ 3ë‹¨ê³„ : Dockerfile & docker-compose ì„¤ì •

[Dockerfile]

FROM python:3.10-slim

RUN apt-get update && apt-get install y \  <!-- ìµœì‹  íŒ¨í‚¤ì§€ ì •ë³´ ì—…ë°ì´íŠ¸ -->
    git \   <!-- í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ -->
    build-essential \  <!-- íŒŒì´ì¬ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œ í•„ìš”í•œ ì»´íŒŒì¼ëŸ¬ ë„êµ¬ ì„¸íŠ¸ -->
    && rm -rf /var/lib/apt/lists/*  <!-- ìºì‹œ ì •ë¦¬ -->

RUN pip install --upgrade pip \  <!-- pip ìµœì‹ í™” -->
    && pip install dbt-bigquery  <!-- dbt-bigquery ì„¤ì¹˜ -->

WORKDIR /usr/app

[docker-compose.yml]

version: '3.8'

services:
    dbt:
        build: .
        container_name: dbt-core
        volumes:
            - .:/usr/app
            - ./.dbt:/root/.dbt
            - ./gcp-key.json:/usr/app/gcp-key.json
        stdin_open: true
        tty: true

# ğŸ”‘ 4ë‹¨ê³„ : GCP ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ë“±ë¡
1. GCP ì½˜ì†” > IAM > ì„œë¹„ìŠ¤ ê³„ì • > í‚¤ ìƒì„± (JSON)
2. í•´ë‹¹ JSON íŒŒì¼ì„ í”„ë¡œì í‹€ ë£¨íŠ¸ì— gcp-key.jsonìœ¼ë¡œ ì €ì¥ 

mv ~/Downloads/your-key.json ./gcp-key.json

# ğŸ§© 5ë‹¨ê³„ : dbt ì—°ê²° ì„¤ì • (.dbt/profiles.yml)
my_dbt_project:
    target: dev
    outputs: 
        dev:
            type: bigquery
            method: service-account
            project: [GCP í”„ë¡œì íŠ¸ ëª…]
            dataset: [GCP dataset ëª…]
            keyfile: /usr/app/gcp-key.json
            threads: 4

# ğŸ§± 6ë‹¨ê³„ : Docker ì‹¤í–‰ ë° dbt í”„ë¡œì íŠ¸ ì´ˆê¸°í™” 

[Docker ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹¤í–‰]
docker-compose up -d --build

[ì»¨í…Œì´ë„ˆ ì ‘ì†]
docker exec -it dbt-core bash

[dbt í”„ë¡œì íŠ¸ ìƒì„±]
dbt init my_dbt_project
cd my_dbt_project

# ğŸ§ª 7ë‹¨ê³„ : dbt ëª¨ë¸ ë° í…ŒìŠ¤íŠ¸ ì •ì˜
ğŸ“„ models/sample/sample_model.sql

-- sample_model.sql
SELECT 
    Country
FROM `[GCP í”„ë¡œì íŠ¸ëª…].[GCP datasetëª…].[tableëª…]`
WHERE Country IS NOT NULL

ğŸ“„ models/sample/schema.sql
-- schema.yml
version: 2

models:
    - name: sample_model
      columns:
        - name: country
          tests:
            - not_null
            - accepted_values:
                values: ['United Kingdom', 'France', 'Germany']

# â–¶ï¸ 8ë‹¨ê³„ : dbt ì‹¤í–‰
[ëª¨ë¸ ë¹Œë“œ]
dbt build

[ë˜ëŠ” ê°œë³„ ëª…ë ¹ì–´]
dbt run
dbt test
